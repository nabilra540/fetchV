importScripts("./js/options.js");let e=2,t=!1,r=1;const o={};try{chrome.action.setBadgeTextColor({color:"#FFFFFF"}),chrome.action.setBadgeBackgroundColor({color:"#FF0000"})}catch(e){}const n=()=>new Promise((e=>{chrome.tabs.query({}).then((async t=>{for(const e of t){const t=`storage${e.id}`;await new Promise((e=>{chrome.storage.local.get(t,(r=>{Object.keys(r).length>0&&(o[t]=r[t]),e()}))}))}e()}))})),i=()=>{const e=e=>{e?.size?.min&&(e.size.min=1024*e.size.min,e.size.min<0&&(e.size.min=0)),e?.size?.max&&(e.size.max=1024*e.size.max,e.size.max<0&&(e.size.max=0))};return new Promise((t=>{try{chrome.storage.sync.get(["options"]).then((r=>{if(void 0!==r.options){const e=r.options;for(let t in OPTION)void 0!==e[t]&&(OPTION[t]=e[t])}e(OPTION),t()}))}catch(r){e(OPTION),t()}}))},s=(e,t)=>{let r=Object.keys(e).length;r=r>0?r.toString():"",chrome.action.setBadgeText({text:r,tabId:t})},a=e=>{chrome.declarativeNetRequest.getSessionRules((function(t){const r=[];for(const o of t)void 0!==o.condition.tabIds&&o.condition.tabIds.includes(e)&&r.push(o.id);r.length>0&&chrome.declarativeNetRequest.updateSessionRules({removeRuleIds:r})}))},c=t=>new Promise((r=>{t?r(t):e?r(e++):chrome.declarativeNetRequest.getSessionRules((function(t){for(const r of t)e=Math.max(e,r.id);r(e++)}))}));chrome.declarativeNetRequest.getSessionRules((async function(e){if(0===e.length)return;const t=await chrome.tabs.query({}),r=[];for(const e of t)r.includes(e.id)||r.push(e.id);const o=[];for(const t of e){if(void 0===t.condition.tabIds)continue;let e=!1;for(const o of t.condition.tabIds)if(r.includes(o)){e=!0;break}e||o.includes(t.id)||o.push(t.id)}o.length>0&&chrome.declarativeNetRequest.updateSessionRules({removeRuleIds:o})})),chrome.runtime.onSuspend.addListener((()=>{chrome.storage.local.clear()})),chrome.runtime.onConnect.addListener((function(e){"POPUP"===e.name&&(t=!0,e.onDisconnect.addListener((function(){t=!1,chrome.declarativeNetRequest.updateDynamicRules({removeRuleIds:[r]})})))})),chrome.runtime.onMessage.addListener((function(e,t,r){const{cmd:n,parameter:s}=e;if("GET_TAB_ID"===n)return r(t.tab.id),!0;if("SET_RULES"===n){const{ruleObject:e,ruleId:t}=s;return c(t).then((t=>{try{e.id=t,chrome.declarativeNetRequest.updateSessionRules({removeRuleIds:[t],addRules:[e]},(function(){chrome.runtime.lastError&&console.log(chrome.runtime.lastError),r(t)}))}catch(e){r(0)}})),!0}if("REMOVE_RULES"===n){const{ruleId:e}=s;return chrome.declarativeNetRequest.updateSessionRules({removeRuleIds:[e]}),r(),!0}if("OPEN_INITIATOR"===n){const{initiator:e}=s;return chrome.tabs.create({url:e,index:t.tab.index+1}),r(""),!0}if("GET_ICON"===n)return r(t.tab.favIconUrl),!0;if("RESET_OPTIONS"===n){const{storageKey:e}=s;return i().then((()=>{if(!e)return void r();const t=o[e],n=[];for(const e in t){const r=t[e],o=new URL(r.url).hostname;o&&OPTION.domain.includes(o)&&n.push(e)}if(n.length>0){for(const e of n)delete t[e];0===Object.keys(t).length?(delete o[e],chrome.storage.local.remove([e],(()=>{r()}))):chrome.storage.local.set({[e]:t},(()=>{r()}))}else r()})),!0}if("TAB_ACTIVE"===n)return chrome.tabs.update(t.tab.id,{active:!0},(()=>{r()})),!0;if("OPEN_DOWNLOADS"===n)return chrome.tabs.create({url:"chrome://downloads/",index:t.tab.index+1}),r(),!0;if("REC_START"===n){const{targetTab:e}=s;return chrome.tabs.update(e,{active:!0}),chrome.tabs.sendMessage(e,{cmd:n,parameter:{tab:t.tab.id}}),r(),!0}if("REC_ON_DATA"===n){const{recorderTab:e,data:t}=s;return chrome.tabs.sendMessage(e,{cmd:n,parameter:{data:t}}),r(),!0}if("REC_STOP"!==n){if("REC_SPEED_UP"===n){const{targetTab:e,speed:t}=s;return chrome.tabs.get(e,(r=>{chrome.runtime.lastError&&console.log(chrome.runtime.lastError),r&&chrome.tabs.sendMessage(e,{cmd:n,parameter:{speed:t}},(()=>{chrome.runtime.lastError&&console.log(chrome.runtime.lastError)}))})),r(),!0}r()}else{const{tabId:e}=s;chrome.tabs.get(e,(e=>{chrome.runtime.lastError&&console.log(chrome.runtime.lastError),e&&chrome.tabs.sendMessage(e.id,{cmd:n,parameter:{}},(()=>{chrome.runtime.lastError&&console.log(chrome.runtime.lastError)}))}))}})),chrome.tabs.onRemoved.addListener((function(e){a(e);const t=`storage${e}`;chrome.storage.local.remove([t]),o[t]&&delete o[t]})),chrome.tabs.onUpdated.addListener((function(e,t,r){if("loading"===t.status&&t.url){const t=`storage${e}`;chrome.storage.local.remove([t],(()=>{s({},e)})),o[t]&&delete o[t]}})),async function(){await i(),await n();const e=(e,t)=>{e=e.toLowerCase();for(let r=0;r<t.length;r++)if(t[r].name.toLowerCase()===e)return t[r].value.toLowerCase();return null},r=(e,t)=>{let r={m3u8:"video/mp4",m3u:"video/mp4",mp4:"video/mp4","3gp":"video/3gpp",flv:"video/x-flv",mov:"video/quicktime",avi:"video/x-msvideo",wmv:"video/x-ms-wmv",webm:"video/webm",ogg:"video/ogg",ogv:"video/ogg",f4v:"video/x-f4v",acc:"application/vnd.americandynamics.acc",mkv:"video/x-matroska",rmvb:"application/vnd.rn-realmedia-vbr",m4s:"video/iso.segment",mp3:"audio/mpeg",wav:"audio/wav"};return r[e]?r[e]:t},a={},c=["youtube.com","globo.com"],l=["m3u8","m3u","mp4","3gp","flv","mov","avi","wmv","webm","f4v","acc","mkv","mp3","wav","ogg"],m=["range","content-length","content-type","accept-encoding","accept","accept-language"];chrome.webRequest.onBeforeSendHeaders.addListener((function(e){if(!e.initiator)return;if(0!==e.initiator.indexOf("http"))return;const t=e.requestHeaders;a[e.requestId]=t||{}}),{urls:["<all_urls>"],types:["media","xmlhttprequest","object","other"]},["requestHeaders","extraHeaders"]),chrome.webRequest.onResponseStarted.addListener((async function(n){let{requestId:i,initiator:d,url:u,tabId:f,responseHeaders:g,statusCode:p}=n,h={};if(a[i]&&(h=a[i],delete a[i]),0!==u.indexOf("http"))return;if(!d)return;if(0!==d.indexOf("http"))return;const v=new URL(d).hostname;for(const e of c)if(v.endsWith(e))return;if(0===d.indexOf(OPTION.site))return;if(-1===f){if(!await new Promise((e=>{chrome.tabs.query({active:!0,lastFocusedWindow:!0}).then((([t])=>{t&&t.url.includes(d)?(f=t.id,e(!0)):e(!1)}))})))return}if(g.length<1)return;if(p<200||p>300)return;const b=new URL(u).hostname;if(b){if((e=>{const t=["doppiocdn","adtng","afcdn","sacdnssedge"],r=e.split(".");r.pop();const o=r.length;if(o>0){const e=r[o-1];if(t.indexOf(e)>-1)return!0}return!1})(b))return;if(OPTION.domain.includes(b))return}let O=0,x=(t=>{let r=e("Content-Range",t);return r?(r=r.split(" "),2!==r.length?null:(r=r[1].split("/"),2!==r.length?null:(r[1]=parseInt(r[1]),r[1]?{chunk:r[0],total:r[1]}:null))):null})(g);O=x?x.total:(t=>{let r=e("Content-Length",t);return r?(r=parseInt(r),r<1?0:r):0})(g);let R=e("content-type",g);if(!R)return;let I=(t=>{const{responseHeaders:r,url:o}=t;let n=null,i=e("content-disposition",r);if(i){i=i.split(";");for(let e=0;e<i.length;e++)if(i[e].indexOf("filename=")>-1){if(i[e]=i[e].replace(/filename=/i,"").replace(/\"/g,"").replace(/\'/g,"").replace(/(^\s*)|(\s*$)/g,""),n=i[e],n)return n;break}}return i=o.replace(/http:\/\//i,"").replace(/https:\/\//i,""),i=i.split("?"),i=i[0].split("/"),i.length<2?null:(i=i[i.length-1],i||n)})(n);I||(I="no-filename");let w=((e,t)=>{if(e.includes("master.txt")&&0===t.indexOf("text/plain"))return"m3u8";let r=(e=>{let t=e.split(".");return t.length<2?null:t[t.length-1].toLowerCase()})(e);const o=["m3u8","m3u","mp4","webm","avi","ogg","flv","mkv","3gp","mp3"];let n={general:{"application/vnd.apple.mpegurl":["m3u8","m3u"],"application/x-mpegurl":["m3u8","m3u"],"application/vnd.americandynamics.acc":["acc"],"application/vnd.rn-realmedia-vbr":["rmvb"],"video/mp4":["mp4","m4s"],"video/3gpp":["3gp"],"video/3gpp2":["3gp2"],"video/x-flv":["flv"],"video/quicktime":["mov"],"video/x-msvideo":["avi"],"video/x-ms-wmv":["wmv"],"video/webm":["webm"],"video/ogg":["ogg","ogv"],"video/x-f4v":["f4v"],"video/x-matroska":["mkv"],"video/iso.segment":["m4s"],"audio/mpeg":["mp3"],"audio/wav":["wav"],"audio/ogg":["ogg"]},stream:{"application/octet-stream":o,"binary/octet-stream":o}};if(n.general[t]){if(!r)return n.general[t][0];let e=n.general[t].indexOf(r);return e<0?n.general[t][0]:n.general[t][e]}if(n.stream[t]){if(!r)return null;let e=n.stream[t].indexOf(r);return e<0?null:n.stream[t][e]}return o.includes(r)?r:null})(I,R);if(!w)return;if(l.indexOf(w)<0)return;let T=w;if("m3u8"!==w&&"m3u"!==w){if(!O)return;if(OPTION.size.min&&O<OPTION.size.min)return;if(OPTION.size.max&&O>OPTION.size.max)return}else T="hls";const P=`storage${f}`;let E=o[P];if(E||(E={},o[P]=E),Object.keys(E).length>30)return;if(((e,t)=>{for(let r in t)if(t[r].url===e)return!0;return!1})(u,E))return;const y={};for(const e in h){const t=h[e];m.includes(t.name.toLowerCase())||(y[t.name]=t.value)}const N="POST"===n.method?"POST":"GET";E[i]={storageKey:P,requestId:i,url:u,method:N,format:w,contentType:r(w,R),name:I,size:O,headers:y,type:T},chrome.storage.local.set({[P]:E}),t&&chrome.runtime.sendMessage({cmd:"POPUP_APPEND_ITEMS",parameter:{tab:f,item:{[i]:E[i]}}}),s(E,f)}),{urls:["<all_urls>"],types:["media","xmlhttprequest","object","other"]},["responseHeaders"])}();